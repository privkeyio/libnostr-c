#include "unity.h"
#include "nostr.h"
#include <string.h>
#include <stdint.h>

void test_constant_time_memcmp_equal(void) {
    uint8_t a[32] = {0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
                     0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10,
                     0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
                     0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20};
    uint8_t b[32];
    memcpy(b, a, 32);
    
    TEST_ASSERT_EQUAL(0, nostr_constant_time_memcmp(a, b, 32));
}

void test_constant_time_memcmp_different(void) {
    uint8_t a[32] = {0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
                     0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10,
                     0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
                     0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20};
    uint8_t b[32] = {0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
                     0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10,
                     0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
                     0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x21};
    
    TEST_ASSERT_NOT_EQUAL(0, nostr_constant_time_memcmp(a, b, 32));
}

void test_constant_time_memcmp_zero_length(void) {
    uint8_t a[1] = {0x42};
    uint8_t b[1] = {0x99};
    
    TEST_ASSERT_EQUAL(0, nostr_constant_time_memcmp(a, b, 0));
}

void test_constant_time_memcmp_single_bit_difference(void) {
    uint8_t a[32] = {0};
    uint8_t b[32] = {0};
    b[15] = 0x01;
    
    TEST_ASSERT_NOT_EQUAL(0, nostr_constant_time_memcmp(a, b, 32));
}

void test_constant_time_memcmp_first_byte_difference(void) {
    uint8_t a[32] = {0x00, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
                     0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10,
                     0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
                     0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20};
    uint8_t b[32] = {0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
                     0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10,
                     0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
                     0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20};
    
    TEST_ASSERT_NOT_EQUAL(0, nostr_constant_time_memcmp(a, b, 32));
}

void test_constant_time_memcmp_last_byte_difference(void) {
    uint8_t a[32] = {0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
                     0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10,
                     0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
                     0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20};
    uint8_t b[32] = {0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
                     0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10,
                     0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
                     0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x21};
    
    TEST_ASSERT_NOT_EQUAL(0, nostr_constant_time_memcmp(a, b, 32));
}

